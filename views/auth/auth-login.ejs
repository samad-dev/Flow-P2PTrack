<!DOCTYPE html>
<html lang="en">

<head>
    <%- include ('../partials/title-meta') %>

        <%- include ('../partials/head-css') %>
</head>

<body class="authentication-bg position-relative">
    <div class="position-absolute start-0 end-0 start-0 bottom-0 w-100 h-100">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink"
            xmlns:svgjs="http://svgjs.com/svgjs" width="100%" height="100%" preserveAspectRatio="none"
            viewBox="0 0 1920 1024">
            <g mask="url(&quot;#SvgjsMask1046&quot;)" fill="none">
                <rect width="1920" height="1024" x="0" y="0" fill="url(#SvgjsLinearGradient1047)"></rect>
                <path d="M1920 0L1864.16 0L1920 132.5z" fill="rgba(255, 255, 255, .1)"></path>
                <path d="M1864.16 0L1920 132.5L1920 298.4L1038.6100000000001 0z" fill="rgba(255, 255, 255, .075)">
                </path>
                <path d="M1038.6100000000001 0L1920 298.4L1920 379.53999999999996L857.7000000000002 0z"
                    fill="rgba(255, 255, 255, .05)"></path>
                <path d="M857.7 0L1920 379.53999999999996L1920 678.01L514.57 0z" fill="rgba(255, 255, 255, .025)">
                </path>
                <path d="M0 1024L939.18 1024L0 780.91z" fill="rgba(0, 0, 0, .1)"></path>
                <path d="M0 780.91L939.18 1024L1259.96 1024L0 585.71z" fill="rgba(0, 0, 0, .075)"></path>
                <path d="M0 585.71L1259.96 1024L1426.79 1024L0 408.19000000000005z" fill="rgba(0, 0, 0, .05)"></path>
                <path d="M0 408.19000000000005L1426.79 1024L1519.6599999999999 1024L0 404.09000000000003z"
                    fill="rgba(0, 0, 0, .025)"></path>
            </g>
            <defs>
                <mask id="SvgjsMask1046">
                    <rect width="1920" height="1024" fill="#ffffff"></rect>
                </mask>
                <linearGradient x1="11.67%" y1="-21.87%" x2="88.33%" y2="121.88%" gradientUnits="userSpaceOnUse"
                    id="SvgjsLinearGradient1047">
                    <stop stop-color="#0e2a47" offset="0"></stop>
                    <stop stop-color="#00459e" offset="1"></stop>
                </linearGradient>
            </defs>
        </svg>
    </div>
    <div class="account-pages pt-2 pt-sm-5 pb-4 pb-sm-5 position-relative">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-xxl-4 col-lg-5">
                    <div class="card">

                        <!-- Logo -->
                        <div class="card-header pt-4 text-center">
                            <div class="auth-brand mb-0">
                                <a href="index" class="logo-dark">
                                    <span><img src="assets/images/logo-dark.png" alt="dark logo" height="28"></span>
                                </a>
                                <a href="index" class="logo-light">
                                    <span><img src="assets/images/logo.png" alt="logo" height="28"></span>
                                </a>
                            </div>
                        </div>

                        <div class="card-body p-4">

                            <div class="text-center w-75 m-auto">
                                <h4 class="text-dark-50 text-center pb-0">Sign In</h4>
                                <p class="text-muted mb-4">Enter your email address and password to access admin panel.
                                </p>
                            </div>

                            <form class="form needs-validation" novalidate action="index">
                                <div id="error" class="text-danger"></div>
                                <div class="mb-3">
                                    <label for="emailaddress" class="form-label">Email address</label>
                                    <input class="form-control" type="email" id="emailaddress" required
                                        placeholder="Enter your email" value="admin@shell.com">
                                </div>
                                <div class="mb-3">
                                    <a href="#" class="text-muted float-end fs-12">Forgot your password?</a>
                                    <label for="password" class="form-label">Password</label>
                                    <div class="input-group input-group-merge">
                                        <input type="password" id="login_password" class="form-control"
                                            placeholder="Enter your password" value="password">
                                        <div class="input-group-text" data-password="false">
                                            <span class="password-eye"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="simpleinput" class="form-label">Scope</label>
                                    <select class="form-control select2" id="login_scope"
                                        data-toggle="select2"></select>
                                </div>
                                <div class="mb-3 mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="checkbox-signin" checked>
                                        <label class="form-check-label" for="checkbox-signin">Remember me</label>
                                    </div>
                                </div>
                                <div class="mb-3 mb-0 text-center">
                                    <button class="btn btn-primary" type="submit" id="login"> Log In</button>
                                </div>
                            </form>
                        </div> <!-- end card-body -->
                    </div>
                    <!-- end card -->


                    <!-- end row -->

                </div> <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- end container -->
    </div>
    <!-- end page -->

    <footer class="footer footer-alt">
        <span class="text-white-50">
            <script>document.write(new Date().getFullYear())</script> Â© Shell - p2ptrack.com
        </span>
    </footer>

    <%- include ('../partials/footer-scripts') %>

        <script>
            $(document).ready(() => {
                select_field('login_scope');
            })
            document.querySelector(".form").addEventListener("submit", function (event) {
                event.preventDefault();

                var form = new FormData();
          
                form.append("email", document.getElementById('emailaddress').value);
                form.append("password", document.getElementById('login_password').value);
                form.append("scope", document.getElementById('login_scope').value);

                var settings = {
                    "url": "/login_auth",
                    "method": "POST",
                    "timeout": 0,
                    "processData": false,
                    "mimeType": "multipart/form-data",
                    "contentType": false,
                    "data": form
                };

                $.ajax({
                    ...settings,
                    success: function (data) {
                        console.log('Logged In Successfully!');
                        localStorage.setItem("User", document.getElementById('emailaddress').value);
                        localStorage.setItem("scope", document.getElementById('login_scope').value);
                        window.location.href = "calendars";
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        if(xhr.status == 401)
                        {
                            console.log(JSON.parse(xhr.responseText));
                            var data = JSON.parse(xhr.responseText);
                            console.log(data.message[0].name);
                            alert(data.message[0].name+" is Already Using the Selected Scope")
                            // Swal.fire({
                            //                         icon: "error",
                            //                         title: "Another User is already Logged In to the Selected Scope.",
                            //                         text: data.message[0].name+" is Already Using the Selected Scope",
                            //                     });
                            
                        }
                        console.log(xhr);
                        console.log(textStatus);
                        console.log(errorThrown);
                        console.log("Request failed with status code: " + xhr.status);
                    }
                });
            });
            function select_field(id) {
                var settings = {
                    "url": "scope",
                    "method": "GET",
                    "timeout": 0,
                };

                $.ajax(settings).done(function (response) {
                    console.log(response)
                    $('#' + id + '').append('<option label="Select..." value="select">Select</option>')


                    for (i = 0; i < response.length; i++) {
                        $('#' + id + '').append($('<option>', {
                            value: response[i]['id'],
                            text: response[i]['name']
                        }));
                    }
                })
            }


            // $('#login').click(() => {
            //     localStorage.setItem("User", email);

            //     var form = new FormData();
            //     form.append("email", $('#emailaddress').val());
            //     form.append("password", $('#password').val());


            //     // Your code to submit the form or any other processing

            //     var settings = {
            //         "url": "login_auth",
            //         "method": "POST",
            //         "timeout": 0,
            //         "headers": {
            //             "Cookie": "connect.sid=s%3Aaz8mfHZmwSTOggI-Zv19Nm314mPw3wNj.tZ52L9XFmD7ZBCX9ZzB8W45d%2BpJh01uhXpaBWzUIahs"
            //         },
            //         "processData": false,
            //         "mimeType": "multipart/form-data",
            //         "contentType": false,
            //         "data": form
            //     };

            //     $.ajax({
            //         ...settings,
            //         statusCode: {
            //             200: function (response) {
            //                 console.log(response);
            //             },

            //         },
            //         success: function (data) {
            //             console.log('Log In Succefully !')

            //             localStorage.setItem("scope", $('#login_scope').val())
            //         },
            //         error: function (xhr, textStatus, errorThrown) {
            //             console.log(xhr)
            //             console.log(textStatus)
            //             console.log(errorThrown)

            //             console.log(errorThrown);


            //             // console.log("Request failed with status code: " + xhr.status);
            //         }
            //     });
            // })

        </script>
        <!-- App js -->
        <script src="assets/js/app.min.js"></script>
</body>

</html>